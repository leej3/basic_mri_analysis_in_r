---
title: "Preliminary analysis of Giedd dataset"
author: "John Lee"
date: "date()"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE,warning=FALSE, message=FALSE)
```

```{r load or install required libraries, warning=FALSE,results='hide'}
for (package in c('stringr', 'ggplot2','dplyr',"readr","tidyr","purrr","broom","GGally")) {
    if (!require(package, character.only=T, quietly=T,warn.conflicts = FALSE)) {
        install.packages(package)
        library(package,
                quietly= TRUE,
                warn.conflicts = FALSE)
    }
}
```
After loading the appropriate R packages the data is loaded.

The aseg.stats files are found by searching all files in the subjects directory. In searching 1193 subjects, 1193 stats files were found.

```{r get_stat_files_list,cache=TRUE}
subject_dirs <- list.dirs(path = "./data/subjects",recursive = FALSE)
dffull <- data_frame(filenames= list.files(path = subject_dirs, recursive=TRUE, full.names = TRUE,no.. = TRUE  ))
dfstats <- dffull %>% filter(str_detect(filenames, "aseg.stats")) %>%
  mutate(subject_id= as.numeric(str_extract(filenames, "\\d{5}")))
```


```{r create_stats_extraction_function}
#A function for extracting information from each stats file is created. This is then applied for all files.
stats_file_fields <- c("index",
                      "seg_id",
                      "n_voxels",
                      "volume_mm3",
                      "struct_name",
                      "norm_mean",
                      "norm_std_dev",
                      "norm_min",
                      "norm_max",
                      "norm_range")
get_volume_summary <- function(path_to_stats_file){
  fs_data <- tbl_df(read.table(path_to_stats_file, header = FALSE))
  names(fs_data) <- stats_file_fields
  file_header <- readLines(path_to_stats_file, 100)
  intra_entry <- file_header[str_detect(file_header,"Intra")]
  tot_intra_cranial <-  as.numeric(str_extract(intra_entry,"(\\d+\\.\\d+)"))
  fs_data %>%
    mutate(normalised_volume = volume_mm3/tot_intra_cranial) %>%
      select(struct_name,normalised_volume)
}
```

```{r extract_stats}
dfstats <- dfstats %>%
  mutate(aseg_stats= map(filenames,get_volume_summary))
```


A quick look at some metadata:

```{r load_demographic_data}
# could not programmatically download this file.
# demographic data can be downloaded from ConnectomeDB after registering
# https://db.humanconnectome.org/
column_headers <- 
c("scan_id", "calibration_studies", "scan_format", "scanner", "scanner_text", "scan_seq_for_person", "family", "fam_ID", "MRN", "LN", "FN", "sex", "race_fed", "ethnicity", "junk", "date_of_scan", "age_of_scan", "plane", "raw_qc", "post_mni_qc", "post_M_C_qc")

dem_data <- read_csv("data/ZZZDataExchange/AdamT_NV_data_exchange_Batch01.csv")
names(dem_data)<- column_headers
dem_data <- dem_data %>%
  mutate(qc_ok= complete.cases(raw_qc, post_mni_qc))
dem_data %>% select(sex,age_of_scan, race_fed, date_of_scan) %>% ggpairs()
```

Metadata exists for every subject dataset. Quality control for 319 subjects is not complet. A plot is included below of the data for both raw and post MNI and CIVET quality control.

```{r qc_plot}
dem_data %>% select(date_of_scan,raw_qc, post_mni_qc) %>% ggpairs()
```


```{r dataset_intersection_and_merge}
# Number of subjects in both data and metadata
subjects_common_to_both <- 
  length(intersect(dem_data$scan_id,dfstats$subject_id))
merged_data <- dfstats %>%
  left_join(dem_data, by= c("subject_id"="scan_id"))
```



 The regression coefficient estimates (beta weights) are listed below for the regression of normalized brain volume with respect to age (continuous variable) and gender.

```{r construct linear models,eval=TRUE}
models <- merged_data %>% unnest() %>%
  group_by(struct_name) %>% nest() %>%
  mutate(model= map(data,
                    ~ lm(normalised_volume ~ age_of_scan+sex,
                         data = .))) %>%
  unnest(model %>%
           map(tidy))
```


Structures where gender has an effect with a significance of p<0.01 are reported:

```{r gender effect, eval=TRUE}
# listing structures where gender had a relatively large effect
gender_effect <-  models %>%
    select(struct_name,term, estimate, p.value) %>% 
    filter(term=="sexM") %>%
    arrange(p.value)
     
gender_effect %>%
    filter(p.value<0.01) %>% 
    print(n=1000)
```


Structures where age has an effect with a significance of p<0.05 are reported:

```{r, eval=TRUE}
# listing structures where age had a relatively large effect
age_effect <-  models %>%
    select(struct_name,term, estimate, p.value) %>% 
    filter(term!="(Intercept)",term!="sexM") %>%
    arrange(p.value)
     
age_effect %>% 
    filter(p.value<0.05) %>% 
    print(n=1000)

```




```{r plot for effect of age, eval=TRUE}
age_effect <-  age_effect %>% 
    arrange(estimate)

# Sort structures according to the maximum estimate in descending order
sorted_structures <- age_effect %>%
 group_by(struct_name) %>%
 filter(estimate==max(estimate)) %>%
 summarise( max_est=first(estimate)) %>%
 arrange(desc(max_est)) %>%
 .$struct_name
#no filter required above. just use summarise(max())


# Draw the plot
age_effect %>%
 ggplot(aes(struct_name,estimate))+
 geom_bar(stat="identity",position="dodge",aes(color=term)) +
 scale_x_discrete(limits = sorted_structures)+
theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
xlab("Structure name")+ 
ylab("Beta weight")+
ggtitle("Effect of age on brain-structure volume")
```


```{r plot for effect of gender, eval=TRUE}
# Statistics on the effect of gender
gender_effect <- gender_effect %>% 
    arrange(estimate)

# Sort structures according to the maximum estimate in descending order
sorted_structures <- gender_effect %>%
 group_by(struct_name) %>%
 filter(estimate==max(estimate)) %>%
 summarise( max_est=first(estimate)) %>%
 arrange(desc(max_est)) %>%
 .$struct_name

# Draw the plot
gender_effect %>%
 ggplot(aes(struct_name,estimate))+
 geom_bar(stat="identity",position="dodge",aes(color=term)) +
 scale_x_discrete(limits = sorted_structures)+
theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
xlab("Structure name")+ 
ylab("Beta weight")+
ggtitle("Effect of gender on brain-structure volume")
```


### To do

+ Use total volume as a regressor instead of dividing the volume of each brain structure by this value
+ Add an interaction term for gender and age
+ Reproduce the plot from the publication where the volume of brain structures changes with age.
+ Correct for multiple comparison?


```{r other stuff}

# with_model <- by_structure %>%
#     mutate(model = purrr::map(data, ~ lm(normalised_volume ~ Age, Gender = .)))
# 
# by_structure %>% 
#   mutate(model = purrr::map(data, ~ lm(normalised_volume ~ Age-1, data = .))) %>% unnest(model %>% purrr::map(broom::tidy))   %>% ggplot()+geom_point(aes(x = struct_name,y = estimate))

# brain_and_demo %>%
#     group_by(Age, Gender) %>%
#     nest() %>%
#     mutate(model = purrr::map(data, ~ lm(normalised_volume ~struct_name-1, data = .))) %>%
#     unnest(model %>% purrr::map(broom::tidy))   %>%
#     ggplot()+geom_point(aes(x = struct_name,y = estimate))
```

