---
title: "Preliminary analysis of Giedd dataset"
author: "John Lee"
date: "date()"
output:
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE,warning=FALSE, message=FALSE)
```

```{r load or install required libraries, warning=FALSE,results='hide'}
for (package in c('stringr', 'ggplot2','dplyr',"readr","tidyr","purrr","broom","GGally","ggvis")) {
    if (!require(package, character.only=T, quietly=T,warn.conflicts = FALSE)) {
        install.packages(package)
        library(package,
                quietly= TRUE,
                warn.conflicts = FALSE)
    }
}
```
After loading the appropriate R packages the data is loaded.

The aseg.stats files are found by searching all files in the subjects directory. In searching 1193 subjects, 1193 stats files were found.

```{r get_stat_files_list,cache=TRUE}
subject_dirs <- list.dirs(path = "./data/subjects",recursive = FALSE)

if (!file.exists("data_temp/data_directory_list.data")){
dffull <- data_frame(filenames= list.files(path = subject_dirs, recursive=TRUE, full.names = TRUE,no.. = TRUE  ))
save(file = "data_temp/data_directory_list.data",dffull)}else{load("data_temp/data_directory_list.data")}

dfstats <- dffull %>% filter(str_detect(filenames, "aseg.stats")) %>%
  mutate(subject_id= as.numeric(str_extract(filenames, "\\d{5}")))
```


```{r create_stats_extraction_function}
#A function for extracting information from each stats file is created. This is then applied for all files.
stats_file_fields <- c("index",
                      "seg_id",
                      "n_voxels",
                      "volume_mm3",
                      "struct_name",
                      "norm_mean",
                      "norm_std_dev",
                      "norm_min",
                      "norm_max",
                      "norm_range")
get_volume_stats <- function(path_to_stats_file){
  fs_data <- tbl_df(read.table(path_to_stats_file, header = FALSE))
  names(fs_data) <- stats_file_fields
  file_header <- readLines(path_to_stats_file, 100)
  intra_entry <- file_header[str_detect(file_header,"Intra")]
  tot_intracranial <-  as.numeric(str_extract(intra_entry,"(\\d+\\.\\d+)"))
  fs_data %>%
    mutate(tot_intracranial = tot_intracranial)      
}
```

```{r extract_stats}
if (!file.exists("data_temp/dfstats.data")){
dfstats <- dfstats %>%
  mutate(aseg_stats= map(filenames,get_volume_stats))
save(file = "data_temp/dfstats.data",dfstats)}else{load("data_temp/dfstats.data")}
```


## A quick look at some metadata

```{r load_demographic_data}
# could not programmatically download this file.
# demographic data can be downloaded from ConnectomeDB after registering
# https://db.humanconnectome.org/
column_headers <- 
c("scan_id", "calibration_studies", "scan_format", "scanner", "scanner_text", "scan_seq_for_person", "family", "fam_ID", "MRN", "LN", "FN", "sex", "race_fed", "ethnicity", "junk", "date_of_scan", "age_at_scan", "plane", "raw_qc", "post_mni_qc", "post_M_C_qc")

dem_data <- read_csv("data/ZZZDataExchange/AdamT_NV_data_exchange_Batch01.csv")
names(dem_data)<- column_headers
dem_data <- dem_data %>%
  mutate(qc_ok= complete.cases(raw_qc, post_mni_qc))


# For each MRN: number of scans, starting age, age difference 
dem_data <- dem_data %>%
  group_by(MRN) %>%
  summarise(person_num_scans = n(),
            person_start_age=min(age_at_scan), 
            person_age_diff= max(age_at_scan)- min(age_at_scan)) %>%
  right_join(dem_data)
# Adding number from family scanned
dem_data <- dem_data %>%
  group_by(fam_ID) %>%
  summarise(num_from_family= n_distinct(MRN)) %>%
  right_join(dem_data)

```

A quick summary of the number of distinct values for each variable is shown below (this makes little sense for continuous variables of course):

```{r metadata_distinct_values}
dem_data %>% summarise_each(funs(n_distinct)) %>% str() # distinct metadata values
```

A plot of some of the categorical variables gives a quick overview of the data:
```{r metadata_overview}
dem_data %>% select(sex,age_at_scan, race_fed, date_of_scan) %>% ggpairs()
```



Metadata exists for every subject dataset. Quality control for 319 subjects is not complete. A plot is included below of the data for both raw and post MNI and CIVET quality control.

```{r qc_plot}
dem_data %>%
  select(date_of_scan,raw_qc, post_mni_qc) %>%
  ggpairs()
```


**ScanSeqForPerson** is described as the "sequence number for scans within individual study participant for this  dataset". I took this to mean that as listed below 1131 people had a first scan and 41 subjects had 3 subsequent scans. I think this is wrong though. See the subsequent analysis using MRN 

```{r scan_seq_for_person, echo=TRUE}
dem_data %>% 
  select(scan_seq_for_person) %>%
  table()
```

There are 545 distinct **MRN** values. Using this it looks like some people got scanned as many as 10 times.
```{r scans_per_person_histogram}
dem_data %>%
  select(MRN,person_num_scans) %>%
  distinct() %>%
  ggplot(aes(person_num_scans))+
  geom_histogram()+
  ggtitle("Distribution of the number of scans per subject")
```

The plot below shows the scans performed over time (with lines connecting a specific MRN). Of the 315 people that have more than 1 data point:

```{r scans_over_time}
dem_data %>%
  filter(person_num_scans>1) %>%
  ggplot(aes(date_of_scan, age_at_scan, group = MRN, color= as.factor(scan_seq_for_person)))+
  geom_point()+
  geom_line()+
  ggtitle("Distribution of the different scan sequences across time")

```




Another metadata variable is the **fam_ID**, descibed as "the family identification number". These numbers repeat within the dataset at a slightly higher frequency (there are only 393 unique IDs). This is perhaps a number of scans done in the same family. 
There are lots of fam_IDs that have just 1 scan associated with them and some that have more than 10. As an additional note the **family** variable has 134 unique values (presumably different families have the same name).


```{r fam_ID_hist}
dem_data  %>% select(MRN,num_from_family) %>%
  distinct() %>%
  ggplot(aes(num_from_family))+
  geom_histogram()+
  ggtitle("The distribution of the number of family members scanned")  

```

**Scanner_text** gives information on the five scanners used. Is there another location for alternative metadata for this sort of stuff? Embedded in the files?


## A statistical model

```{r dataset_intersection_and_merge}
# Number of subjects in both data and metadata
subjects_common_to_both <- 
  length(intersect(dem_data$scan_id,dfstats$subject_id))
merged_data <- dfstats %>%
  left_join(dem_data, by= c("subject_id"="scan_id"))
```



 The regression coefficient estimates (beta weights) are listed below for the regression of normalized brain volume with respect to age (continuous variable) and gender.

```{r construct linear models,echo=TRUE}
models <- merged_data %>% unnest() %>%
  group_by(struct_name) %>% nest() %>%
  mutate(model= map(data,
                    # Interaction terms are included
                    ~ lm(volume_mm3 ~ tot_intracranial*age_at_scan*sex,
                         data = .))) %>%
  unnest(model %>%
           map(tidy))
```


Structures where gender has an effect with a significance of p<0.01 are reported:

```{r gender effect, eval=TRUE}
# listing structures where gender had a relatively large effect
gender_effect <-  models %>%
    select(struct_name,term, estimate, p.value) %>% 
    filter(term=="sexM") %>%
    arrange(p.value)
     
gender_effect %>%
    filter(p.value<0.01) %>% 
    print(n=1000)
```


Structures where age has an effect with a significance of p<0.05 are reported:

```{r, eval=TRUE}
# listing structures where age had a relatively large effect
age_effect <-  models %>%
    select(struct_name,term, estimate, p.value) %>% 
    filter(term=="age_at_scan") %>%
    arrange(p.value)
     
age_effect %>% 
    filter(p.value<0.05) %>% 
    print(n=1000)

```



## Plotting the data

```{r plot for effect of age, eval=TRUE}
age_effect <-  age_effect %>% 
    arrange(estimate)

# Sort structures according to the maximum estimate in descending order
sorted_structures <- age_effect %>%
 group_by(struct_name) %>%
 filter(estimate==max(estimate)) %>%
 summarise( max_est=first(estimate)) %>%
 arrange(desc(max_est)) %>%
 .$struct_name
#no filter required above. just use summarise(max())


# Draw the plot
age_effect %>%
 ggplot(aes(struct_name,estimate))+
 geom_bar(stat="identity",position="dodge",aes(color=term)) +
 scale_x_discrete(limits = sorted_structures)+
theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
xlab("Structure name")+ 
ylab("Beta weight")+
ggtitle("Effect of age on brain-structure volume")
```


```{r plot for effect of gender, eval=TRUE}
# Statistics on the effect of gender
gender_effect <- gender_effect %>% 
    arrange(estimate)

# Sort structures according to the maximum estimate in descending order
sorted_structures <- gender_effect %>%
 group_by(struct_name) %>%
 filter(estimate==max(estimate)) %>%
 summarise( max_est=first(estimate)) %>%
 arrange(desc(max_est)) %>%
 .$struct_name

# Draw the plot
gender_effect %>%
 ggplot(aes(struct_name,estimate))+
 geom_bar(stat="identity",position="dodge",aes(color=term)) +
 scale_x_discrete(limits = sorted_structures)+
theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
xlab("Structure name")+ 
ylab("Beta weight")+
ggtitle("Effect of gender on brain-structure volume")
```

A draft plot of the change in volume over time. Will probably only use scan sequence one, which will also end up filtering out the older subjects. 
```{r change_in_brain_size_with_time}
merged_data %>% unnest() %>%
  filter(struct_name %in% "Brain-Stem",
         person_start_age<30,
         scan_seq_for_person==1,
         person_num_scans>1) %>%
  mutate(normalised_volume= volume_mm3/tot_intracranial) %>%
  ggplot(aes(age_at_scan,
             normalised_volume,
             group= MRN))+
  geom_point()+
  geom_line()+
  facet_grid(sex~.)+
  ggtitle("Change of volume in the brain-stem with age")
  
```



### To do
+ Use a linear mixed effects model.
+ Reproduce the plot from the publication where the volume of brain structures changes with age.
+ Correct for multiple comparison?
+ Use rslurm

### Done

+ Use total volume as a regressor instead of dividing the volume of each brain structure by this value. Done
+ replicate analysis on giedd data
+ add interaction terms.
+ brain segmentation volume instead of total intracranial? Nope, that has other uses
+ take all info from aseg files to avoid searching through them again.
+ Check why NA is occurring in some brain regions. Think its just the estimate of the term is 0. Acutally I think the regions just weren't found (hypointensities). 


```{r other stuff}
# 
```

